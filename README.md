
# SkyScan

**SkyScan** — это веб-приложение для просмотра прогноза погоды в любом городе. Пользователь вводит название города, получает удобный и читаемый прогноз, а все запросы сохраняются для будущего использования.

---

## Что реализовано

- **Ввод города и вывод прогноза**
  Пользователь вводит название города в форму, нажимает «Get Weather» и получает текущий почасовой прогноз температуры.

- **Удобный формат прогноза**
  Прогноз выводится списком ближайших часов с отметкой времени и температурой.

- **Автодополнение (typeahead)**
  При вводе первого символа запрос отправляется на геокодинг API, и под полем появляется список подходящих городов (с выделением совпадающих букв).
  - Подсказки появляются сразу после ввода первой буквы.
  - Реализована навигация стрелками и выбор кликом.

- **Предложение последнего города при повторной загрузке**
  Если пользователь уже искал погоду в каком-то городе (сохраняется по cookie), на главной странице появляется кнопка «See weather for `<последний город>`».

- **История поиска**
  Для каждого анонимного пользователя (`anon_uuid` в cookie) сохраняется история последних 5 городов.
  - Есть API **GET `/api/suggest?query=<q>`** — возвращает до 5 популярных исторических городов, совпадающих с `<q>`, и дополняет их результатами внешнего API (максимум 10 всего).
  - Есть API **GET `/api/weather?city=<name>`** — возвращает JSON с полной информацией о городе и прогнозом.

- **Тесты**
  - Юнит-тесты для сервисов погоды (`tests/test_weather_service.py`)
  - Интеграционные тесты для веб-роутов (`tests/test_web.py`, `tests/test_api.py`)
  - Полный end-to-end тест (`tests/test_full_flow.py`)

- **Докеризация**
  - `Dockerfile` для сборки образа FastAPI + Alembic + Uvicorn
  - `docker-compose.yml` для поднятия сервисов Postgres + Web
  - Скрипт `wait-for-db.sh`, чтобы подождать БД перед запуском миграций

- **Миграции**
  Настроен Alembic, есть скрипты миграций для создания таблиц `users` и `search_history`.

- **CI/CD** (GitHub Actions)
  В репозитории настроен workflow `.github/workflows/ci.yml`, который при push/pull_request:
  - Устанавливает Python 3.13 + Poetry
  - Прогоняет линтеры (flake8, isort), mypy, тесты
  - Собирает Docker-образ и проверяет запуск и health-check

---

## Технологии и зависимости

- **Язык:** Python 3.13
- **Веб-фреймворк:** FastAPI
- **Асинхронная БД:** PostgreSQL + SQLAlchemy (asyncpg)
- **Миграции:** Alembic
- **HTTP-клиент:** httpx + respx (для мокирования в тестах)
- **Шаблоны:** Jinja2
- **Тесты:** pytest, pytest-asyncio
- **Typing & linting:** Mypy, flake8, isort
- **Контейнеризация:** Docker, Docker Compose
- **CI:** GitHub Actions

---

## Запуск проекта

1. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/your-org/SkyScan.git
   cd SkyScan
   ```

2. Скопируйте пример файла окружения и отредактируйте:

   ```bash
   cp .env.example .env
   # задайте свои значения, особенно DATABASE_URL
   ```

3. Поднимите сервисы Docker Compose:

   ```bash
   docker-compose up --build
   ```

   Первый запуск может занять некоторое время (скачивание образов, установка зависимостей).

   Контейнер web подождёт, пока db не станет доступен, выполнит миграции и запустит Uvicorn.

4. Откройте в браузере:

   ```
   http://localhost:8000
   ```

5. Для запуска тестов локально (без Docker):

   ```bash
   poetry install
   poetry run pytest --maxfail=1 -q
   ```

## Как пользоваться

- **Главная страница:**
    - Поле ввода города. Начните ввод — появятся подсказки.
    - Нажмите Enter или выберите город из списка и кликните «Get Weather».

- **Повторный визит:**
    - Если cookie anon_uuid сохранены и в истории есть города — отобразится кнопка «See weather for <последний город>».

- **API:**
    - `GET /api/suggest?query=<q>`
      Возвращает список объектов `{ name, country, country_code, latitude, longitude, timezone }`.
    - `GET /api/weather?city=<name>`
      Возвращает `{ city: {…}, forecast: {…} }` или 404, если город не найден.
