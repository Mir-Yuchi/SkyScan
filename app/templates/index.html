<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SkyScan Weather</title>
    <style>
      /* Autocomplete dropdown */
      #suggestions {
        list-style: none;
        margin: 0;
        padding: 0;
        border: 1px solid #ccc;
        max-width: 300px;
        position: absolute;
        background: #fff;
      }
      #suggestions li { padding: 4px 8px; cursor: pointer; }
      #suggestions li.active { background: #eef; }
      #suggestions li.loading,
      #suggestions li.none,
      #suggestions li.error { font-style: italic; }

      .matched { font-weight: bold; }
      .recent-list { list-style: none; padding: 0; }
      .recent-list li { display: inline-block; margin-right: 8px; }

      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 500px;
        margin-bottom: 1em;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 4px 8px;
        text-align: left;
      }
      th { background: #f0f0f0; }
    </style>
  </head>
  <body>
    <h1>SkyScan Weather</h1>

    {% if recent_cities %}
      {% set last_city = recent_cities[0] %}
      <p>
        Welcome back!
        <form action="/weather" method="post" style="display:inline;">
          <input type="hidden" name="city" value="{{ last_city }}" />
          <button type="submit">See weather for {{ last_city }}</button>
        </form>
      </p>

      <p>Your recent cities:</p>
      <ul class="recent-list">
        {% for name in recent_cities %}
          <li>
            <form action="/weather" method="post" style="display:inline;">
              <input type="hidden" name="city" value="{{ name }}" />
              <button type="submit">{{ name }}</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <form action="/weather" method="post" autocomplete="off" style="position: relative;">
      <input
        type="text"
        id="city-input"
        name="city"
        placeholder="Enter city"
        required
        value="{{ city.name if city else '' }}"
      />
      <ul id="suggestions"></ul>
      <button type="submit">Get Weather</button>
    </form>

    {% if preview %}
      <h2>Forecast for {{ city.name }}</h2>

      <!-- Next 6-hour preview -->
      <table>
        <thead>
          <tr><th>Time</th><th>Temp (°C)</th></tr>
        </thead>
        <tbody>
          {% for t, temp in preview %}
            <tr>
              <td>{{ t }}</td>
              <td>{{ temp }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Show full hourly toggle -->
      <button id="show-more">Show full hourly forecast</button>
      <div id="full-forecast" style="display:none; margin-top:1em;">
        <table>
          <thead>
            <tr><th>Time</th><th>Temp (°C)</th></tr>
          </thead>
          <tbody>
            {% for t, temp in full %}
              <tr>
                <td>{{ t }}</td>
                <td>{{ temp }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <script>
        document.getElementById('show-more').addEventListener('click', () => {
          document.getElementById('full-forecast').style.display = 'block';
          document.getElementById('show-more').style.display    = 'none';
        });
      </script>
    {% endif %}

    <script>
      const input = document.getElementById('city-input');
      const sugg  = document.getElementById('suggestions');
      let timer = null, selected = -1, lastList = [];

      input.addEventListener('input', () => {
        clearTimeout(timer);
        const q = input.value.trim();
        if (!q) return (sugg.innerHTML = '');
        timer = setTimeout(fetchSuggestions, 200);
      });

      async function fetchSuggestions() {
        sugg.innerHTML = '<li class="loading">Loading…</li>';
        try {
          const res = await fetch(
            `/api/suggest?query=${encodeURIComponent(input.value.trim())}`
          );
          const list = res.ok ? await res.json() : [];
          lastList = list;
          if (!list.length) {
            sugg.innerHTML = '<li class="none">No matches</li>';
          } else {
            sugg.innerHTML = list
              .map((c,i) => `<li data-idx="${i}">${highlight(c.name)}</li>`)
              .join('');
          }
          selected = -1;
        } catch {
          sugg.innerHTML = '<li class="error">Error</li>';
        }
      }

      function highlight(name) {
        const q = input.value.trim().replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        return name.replace(
          new RegExp(`^(${q})`, 'i'),
          '<span class="matched">$1</span>'
        );
      }

      sugg.addEventListener('click', (e) => {
        const li = e.target.closest('li[data-idx]');
        if (!li) return;
        input.value = lastList[+li.dataset.idx].name;
        sugg.innerHTML = '';
      });

      input.addEventListener('keydown', (e) => {
        const items = sugg.querySelectorAll('li[data-idx]');
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
          selected = Math.min(selected + 1, items.length - 1);
        } else if (e.key === 'ArrowUp') {
          selected = Math.max(selected - 1, 0);
        } else if (e.key === 'Enter' && selected >= 0) {
          input.value = lastList[selected].name;
          sugg.innerHTML = '';
        } else {
          return;
        }
        items.forEach(li => li.classList.remove('active'));
        items[selected].classList.add('active');
        e.preventDefault();
      });

      document.addEventListener('click', (e) => {
        if (e.target !== input) sugg.innerHTML = '';
      });
    </script>
  </body>
</html>
